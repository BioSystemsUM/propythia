

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>propythia.machine_learning &mdash; ProPythia 0.04 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> ProPythia
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">here will be a mega pretty file explaining everything</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../src.html">Source Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides.html">Guides</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ProPythia</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>propythia.machine_learning</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for propythia.machine_learning</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">##############################################################################</span>

<span class="sd">File containing a class intend to facilitate machine learning with peptides.</span>
<span class="sd">The functions are based on the package scikit learn.</span>
<span class="sd">The organization of the code is based on the mddlamp package.</span>

<span class="sd">Authors: Ana Marta Sequeira</span>

<span class="sd">Date:06/2019</span>

<span class="sd">Email:</span>

<span class="sd">##############################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">propythia.sequence</span> <span class="kn">import</span> <span class="n">ReadSequence</span>
<span class="kn">from</span> <span class="nn">propythia.descriptors</span> <span class="kn">import</span> <span class="n">Descriptor</span>
<span class="kn">from</span> <span class="nn">propythia.adjuv_functions.sequence.get_sub_seq</span> <span class="kn">import</span> <span class="n">sub_seq_sliding_window</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">validation_curve</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span> <span class="k">as</span> <span class="n">mets</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">SGDClassifier</span><span class="p">,</span> <span class="n">LogisticRegressionCV</span>
<span class="kn">from</span> <span class="nn">sklearn.naive_bayes</span> <span class="kn">import</span> <span class="n">GaussianNB</span>
<span class="kn">from</span> <span class="nn">sklearn.neural_network</span> <span class="kn">import</span> <span class="n">MLPClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">learning_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">ShuffleSplit</span><span class="p">,</span> <span class="n">train_test_split</span>

<span class="c1"># import scikitplot as skplt</span>
<span class="c1"># from more_itertools import unique_everseen</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="MachineLearning"><a class="viewcode-back" href="../../propythia.html#propythia.machine_learning.MachineLearning">[docs]</a><span class="k">class</span> <span class="nc">MachineLearning</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The MachineLearning class aims to process different models of machine learning with peptides.</span>
<span class="sd">    Based on scikit learn.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sklearn_load</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">test_size</span><span class="p">,</span><span class="n">classes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load the data. the inputs are inherited from the init function when the class is called.</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sklearn_load</span>
        <span class="n">X_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_data</span><span class="o">=</span><span class="n">X_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y_data</span><span class="o">=</span><span class="n">target</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">label_binarize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_data</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">))</span> <span class="c1"># ham will be 0 and spam will be 1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="c1"># self.y_train_encoded=np.ravel(label_binarize(self.y_train, classes=[&#39;fps&#39;,&#39;tmds&#39;])) # ham will be 0 and spam will be 1</span>
        <span class="c1"># self.y_test_encoded=np.ravel(label_binarize(self.y_test, classes=[&#39;fps&#39;,&#39;tmds&#39;])) # ham will be 0 and spam will be 1</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sklearn_load</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="s1">&#39;neg&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        init function. When the class is called a dataset containing the features values and a target column must be provided.</span>
<span class="sd">        Test size is by default 0.3 but can be altered by user.</span>

<span class="sd">        :param sklearn_load: dataset X_data</span>
<span class="sd">        :param target: column with class labels</span>
<span class="sd">        :param test_size: size for division of the dataset in train and tests</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_data</span><span class="p">(</span><span class="n">sklearn_load</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">test_size</span><span class="p">,</span><span class="n">classes</span><span class="p">)</span>

<div class="viewcode-block" id="MachineLearning.train_best_model"><a class="viewcode-back" href="../../propythia.html#propythia.machine_learning.MachineLearning.train_best_model">[docs]</a>    <span class="k">def</span> <span class="nf">train_best_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">sample_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="n">StandardScaler</span><span class="p">(),</span>
                     <span class="n">score</span><span class="o">=</span><span class="n">make_scorer</span><span class="p">(</span><span class="n">matthews_corrcoef</span><span class="p">),</span> <span class="n">param_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function performs a parameter grid search on a selected classifier model and peptide training data set.</span>
<span class="sd">        It returns a scikit-learn pipeline that performs standard scaling and contains the best model found by the</span>
<span class="sd">        grid search according to the Matthews correlation coefficient.</span>

<span class="sd">        :param model: {str} model to train. Choose between &#39;svm&#39;, &#39;knn&#39;, &#39;sgd&#39;, &#39;lr&#39;,&#39;rf&#39;, &#39;gnb&#39;, &#39;nn&#39;,&#39;gboosting&#39;</span>
<span class="sd">        :param x_train: {array} descriptor values for training data.</span>
<span class="sd">        :param y_train: {array} class values for training data.</span>
<span class="sd">        :param sample_weights: {array} sample weights for training data.</span>
<span class="sd">        :param scaler: {scaler} scaler to use in the pipe to scale data prior to training. Choose from</span>
<span class="sd">            ``sklearn.preprocessing``, e.g. &#39;StandardScaler()&#39;, &#39;MinMaxScaler()&#39;, &#39;Normalizer()&#39;.</span>
<span class="sd">        :param score: {metrics instance} scoring function built from make_scorer() or a predefined value in string form</span>
<span class="sd">            (choose from the scikit-learn`scoring-parameters</span>
<span class="sd">            &lt;http://scikit-learn.org/stable/modules/model_evaluation.html#scoring-parameter&gt;`_).</span>
<span class="sd">        :param param_grid:</span>
<span class="sd">            {dict} parameter grid for the gridsearch (see`sklearn.grid_search</span>
<span class="sd">            &lt;http://scikit-learn.org/stable/modules/model_evaluation.html&gt;`_)</span>
<span class="sd">            \n **Default parameter grids:**</span>

<span class="sd">            \n =================                   =====================================================================</span>
<span class="sd">            \n Model                                Parameter grid</span>
<span class="sd">            \n =================                   =====================================================================</span>
<span class="sd">            \n SVM</span>
<span class="sd">                                                    param_grid = [{</span>
<span class="sd">                                                    &#39;clf__C&#39;: [0.00001, 0.0001, 0.001, 0.01, 0.1, 1.0, 10.0],</span>
<span class="sd">                                                    &#39;clf__kernel&#39;: [&#39;linear&#39;],</span>
<span class="sd">                                                    &#39;clf__gamma&#39;: [0.00001, 0.0001, 0.001, 0.01, 0.1, 1.0, 10.0]}]</span>

<span class="sd">            \n Random Forest (RF)</span>
<span class="sd">                                                    param_grid = [{</span>
<span class="sd">                                                    &#39;clf__n_estimators&#39;: [10, 100, 500],</span>
<span class="sd">                                                    &#39;clf__max_features&#39;: [&#39;sqrt&#39;, &#39;log2&#39;],</span>
<span class="sd">                                                    &#39;clf__bootstrap&#39;: [True],</span>
<span class="sd">                                                    &#39;clf__criterion&#39;: [&quot;gini&quot;]}]</span>

<span class="sd">            \n k Nearest Neighbours (KNN)</span>
<span class="sd">                                                    param_grid = [{</span>
<span class="sd">                                                    &#39;clf__n_neighbors&#39;: [2, 5, 10, 15],</span>
<span class="sd">                                                    &#39;clf__weights&#39;: [&#39;uniform&#39;, &#39;distance&#39;],</span>
<span class="sd">                                                    &#39;clf__leaf_size&#39;:[15, 30, 60]}]</span>

<span class="sd">            \n Stochastic Gradient Descent (SGD)</span>
<span class="sd">                                                    param_grid = [{</span>
<span class="sd">                                                    &#39;clf__loss&#39;: [&#39;hinge&#39;, &#39;log&#39;, &#39;modified_huber&#39;,&#39;perceptron&#39;],</span>
<span class="sd">                                                    &#39;clf__penalty&#39;: [&#39;l2&#39;, &#39;l1&#39;,&#39;elasticnet&#39;],</span>
<span class="sd">                                                    &#39;clf__alpha&#39;: [0.00001, 0.0001, 0.001, 0.01, 0.1, 1.0, 10.0]}]</span>

<span class="sd">            \n Logistic Regression CV (LR)</span>
<span class="sd">                                                    param_grid = [{</span>
<span class="sd">                                                    &#39;clf__Cs&#39;: param_range = [0.001,0.01,0.1,1.0,10.0,100,1000],</span>
<span class="sd">                                           &#39;         &#39;clf__solver&#39;: [&#39;newton-cg&#39;, &#39;lbfgs&#39;, &#39;sag&#39;]}]</span>

<span class="sd">            \n Gaussian Naive Bayes (GNB)</span>
<span class="sd">                                                    param_grid = [{</span>
<span class="sd">                                                    &#39;clf__var_smoothing&#39;: [1e-12, 1e-9, 1e-4]}]</span>

<span class="sd">            \n Neural network  (NN)</span>
<span class="sd">                                                    param_grid = [{</span>
<span class="sd">                                                    &#39;clf__activation&#39;: [&#39;identity&#39;, &#39;logistic&#39;, &#39;tanh&#39;, &#39;relu&#39;],</span>
<span class="sd">                                                    #&#39;clf__solver&#39;: [&#39;lbfgs&#39;, &#39;sgd&#39;, &#39;adam&#39;],</span>
<span class="sd">                                                    #&#39;clf__learning_rate&#39;: [ &#39;constant&#39;, &#39;invscaling&#39;, &#39;adaptive&#39;],</span>
<span class="sd">                                                    &#39;clf__batch_size&#39;: [0,5,10]}]</span>

<span class="sd">            \n Gradient Boosting (gboosting)</span>
<span class="sd">                                                    param_grid = [{</span>
<span class="sd">                                                    &#39;clf__loss&#39;: [&#39;deviance&#39;, &#39;exponential&#39;],</span>
<span class="sd">                                                    &#39;clf__n_estimators&#39;: [10, 100, 500],</span>
<span class="sd">                                                    &#39;clf__max_depth&#39;: [1,3,5,10]}]</span>
<span class="sd">            =================                   ========================================================================</span>

<span class="sd">        :param n_jobs: {int} number of parallel jobs to use for calculation. if ``-1``, all available cores are used.</span>
<span class="sd">        :param cv: {int} number of folds for cross-validation.</span>

<span class="sd">        :return: best estimator pipeline.</span>

<span class="sd">        Based on a function from moodlamp</span>
<span class="sd">        Müller A. T. et al. (2017) modlAMP: Python for anitmicrobial peptides, Bioinformatics 33, (17), 2753-2755,</span>
<span class="sd">        DOI:10.1093/bioinformatics/btx285</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;performing grid search...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;svm&#39;</span><span class="p">:</span>
            <span class="n">pipe_svc</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s1">&#39;scl&#39;</span><span class="p">,</span> <span class="n">scaler</span><span class="p">),</span>
                                 <span class="p">(</span><span class="s1">&#39;clf&#39;</span><span class="p">,</span> <span class="n">SVC</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">))])</span>

            <span class="k">if</span> <span class="n">param_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param_range</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.00001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">]</span>
                <span class="n">param_grid</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;clf__C&#39;</span><span class="p">:</span> <span class="n">param_range</span><span class="p">,</span>
                               <span class="s1">&#39;clf__kernel&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;clf__gamma&#39;</span><span class="p">:</span> <span class="n">param_range</span>
                               <span class="c1"># &#39;clf__kernel&#39;: [&#39;rbf&#39;] does not allow to retrieve feature importances with rbf kernel</span>
                               <span class="p">}]</span>

            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">pipe_svc</span><span class="p">,</span>
                              <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span>
                              <span class="c1"># fit_params={&#39;clf__sample_weight&#39;: sample_weights},</span>
                              <span class="n">scoring</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                              <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
                              <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>

            <span class="n">gs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best score </span><span class="si">%s</span><span class="s2"> (scorer: </span><span class="si">%s</span><span class="s2">) and parameters from a </span><span class="si">%d</span><span class="s2">-fold cross validation:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                                                                                  <span class="n">score</span><span class="p">,</span> <span class="n">cv</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MCC score:</span><span class="se">\t</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameters:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>

            <span class="c1"># Set the best parameters to the best estimator</span>
            <span class="n">best_classifier</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_estimator_</span>
            <span class="n">best_classifier_fit</span><span class="o">=</span><span class="n">best_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">best_classifier_fit</span>

        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rf&#39;</span><span class="p">:</span>
            <span class="n">pipe_rf</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s1">&#39;scl&#39;</span><span class="p">,</span> <span class="n">scaler</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">&#39;clf&#39;</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">))])</span>

            <span class="k">if</span> <span class="n">param_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param_grid</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;clf__n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">],</span>
                               <span class="s1">&#39;clf__max_features&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;log2&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;clf__bootstrap&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">],</span>
                               <span class="s1">&#39;clf__criterion&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;gini&quot;</span><span class="p">]}]</span>

            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">pipe_rf</span><span class="p">,</span>
                              <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span>
                              <span class="n">scoring</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                              <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
                              <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>

            <span class="n">gs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best score </span><span class="si">%s</span><span class="s2"> (scorer: </span><span class="si">%s</span><span class="s2">) and parameters from a </span><span class="si">%d</span><span class="s2">-fold cross validation:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                                                                                  <span class="n">score</span><span class="p">,</span> <span class="n">cv</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MCC score:</span><span class="se">\t</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameters:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>

            <span class="c1"># Set the best parameters to the best estimator</span>
            <span class="n">best_classifier</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_estimator_</span>
            <span class="n">best_classifier_fit</span><span class="o">=</span><span class="n">best_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">best_classifier_fit</span>

        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;gboosting&#39;</span><span class="p">:</span>
            <span class="n">pipe_rf</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s1">&#39;scl&#39;</span><span class="p">,</span> <span class="n">scaler</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">&#39;clf&#39;</span><span class="p">,</span> <span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">))])</span>

            <span class="k">if</span> <span class="n">param_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param_grid</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;clf__loss&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;deviance&#39;</span><span class="p">,</span> <span class="s1">&#39;exponential&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;clf__n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">],</span>
                               <span class="s1">&#39;clf__max_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">]}]</span>

            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">pipe_rf</span><span class="p">,</span>
                              <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span>
                              <span class="n">scoring</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                              <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
                              <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>

            <span class="n">gs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best score </span><span class="si">%s</span><span class="s2"> (scorer: </span><span class="si">%s</span><span class="s2">) and parameters from a </span><span class="si">%d</span><span class="s2">-fold cross validation:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                                                                                  <span class="n">score</span><span class="p">,</span> <span class="n">cv</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MCC score:</span><span class="se">\t</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameters:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>

            <span class="c1"># Set the best parameters to the best estimator</span>
            <span class="n">best_classifier</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_estimator_</span>
            <span class="n">best_classifier_fit</span><span class="o">=</span><span class="n">best_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">best_classifier_fit</span>

        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;knn&#39;</span><span class="p">:</span>
            <span class="n">pipe_rf</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s1">&#39;scl&#39;</span><span class="p">,</span> <span class="n">scaler</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">&#39;clf&#39;</span><span class="p">,</span> <span class="n">KNeighborsClassifier</span><span class="p">())])</span>

            <span class="k">if</span> <span class="n">param_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param_grid</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;clf__n_neighbors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
                               <span class="s1">&#39;clf__weights&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;clf__leaf_size&#39;</span><span class="p">:[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">]}]</span>

            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">pipe_rf</span><span class="p">,</span>
                              <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span>
                              <span class="n">scoring</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                              <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
                              <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>

            <span class="n">gs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best score </span><span class="si">%s</span><span class="s2"> (scorer: </span><span class="si">%s</span><span class="s2">) and parameters from a </span><span class="si">%d</span><span class="s2">-fold cross validation:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                                                                                  <span class="n">score</span><span class="p">,</span> <span class="n">cv</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MCC score:</span><span class="se">\t</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameters:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>

            <span class="c1"># Set the best parameters to the best estimator</span>
            <span class="n">best_classifier</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_estimator_</span>
            <span class="k">return</span> <span class="n">best_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sgd&#39;</span><span class="p">:</span>
            <span class="n">pipe_rf</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s1">&#39;scl&#39;</span><span class="p">,</span> <span class="n">scaler</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">&#39;clf&#39;</span><span class="p">,</span> <span class="n">SGDClassifier</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">))])</span>

            <span class="k">if</span> <span class="n">param_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param_grid</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;clf__loss&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;hinge&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;modified_huber&#39;</span><span class="p">,</span> <span class="s1">&#39;perceptron&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;clf__penalty&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="s1">&#39;l1&#39;</span><span class="p">,</span><span class="s1">&#39;elasticnet&#39;</span><span class="p">],</span>
                                <span class="s1">&#39;clf__alpha&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.00001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">]}]</span>

            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">pipe_rf</span><span class="p">,</span>
                              <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span>
                              <span class="n">scoring</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                              <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
                              <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>

            <span class="n">gs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best score </span><span class="si">%s</span><span class="s2"> (scorer: </span><span class="si">%s</span><span class="s2">) and parameters from a </span><span class="si">%d</span><span class="s2">-fold cross validation:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                                                                                  <span class="n">score</span><span class="p">,</span> <span class="n">cv</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MCC score:</span><span class="se">\t</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameters:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>

            <span class="c1"># Set the best parameters to the best estimator</span>
            <span class="n">best_classifier</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_estimator_</span>
            <span class="k">return</span> <span class="n">best_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;lr&#39;</span><span class="p">:</span>
            <span class="n">pipe_lr</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s1">&#39;scl&#39;</span><span class="p">,</span> <span class="n">scaler</span><span class="p">),</span>
                                 <span class="p">(</span><span class="s1">&#39;clf&#39;</span><span class="p">,</span> <span class="n">LogisticRegressionCV</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">))])</span>

            <span class="k">if</span> <span class="n">param_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param_range</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span> <span class="c1"># np.logspace(-4, 4, 10)</span>
                <span class="n">param_grid</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;clf__Cs&#39;</span><span class="p">:</span> <span class="n">param_range</span><span class="p">,</span>
                               <span class="s1">&#39;clf__solver&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;newton-cg&#39;</span><span class="p">,</span> <span class="s1">&#39;lbfgs&#39;</span><span class="p">,</span> <span class="s1">&#39;sag&#39;</span><span class="p">],</span> <span class="c1">#solvers with l1 penalization</span>
                               <span class="p">}]</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">pipe_lr</span><span class="p">,</span>
                              <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span>
                              <span class="c1"># fit_params={&#39;clf__sample_weight&#39;: sample_weights},</span>
                              <span class="n">scoring</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                              <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
                              <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>

            <span class="n">gs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best score </span><span class="si">%s</span><span class="s2"> (scorer: </span><span class="si">%s</span><span class="s2">) and parameters from a </span><span class="si">%d</span><span class="s2">-fold cross validation:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                                                                                  <span class="n">score</span><span class="p">,</span> <span class="n">cv</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MCC score:</span><span class="se">\t</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameters:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>

            <span class="c1"># Set the best parameters to the best estimator</span>
            <span class="n">best_classifier</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_estimator_</span>
            <span class="n">best_classifier_fit</span><span class="o">=</span><span class="n">best_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">best_classifier_fit</span>

        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;gnb&#39;</span><span class="p">:</span>
            <span class="n">pipe_rf</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s1">&#39;scl&#39;</span><span class="p">,</span> <span class="n">scaler</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">&#39;clf&#39;</span><span class="p">,</span> <span class="n">GaussianNB</span><span class="p">(</span><span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">var_smoothing</span><span class="o">=</span><span class="mf">1e-09</span><span class="p">))])</span>

            <span class="k">if</span> <span class="n">param_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param_grid</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;clf__var_smoothing&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1e-12</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">]}]</span>

            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">pipe_rf</span><span class="p">,</span>
                              <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span>
                              <span class="n">scoring</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                              <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
                              <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>

            <span class="n">gs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best score </span><span class="si">%s</span><span class="s2"> (scorer: </span><span class="si">%s</span><span class="s2">) and parameters from a </span><span class="si">%d</span><span class="s2">-fold cross validation:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                                                                                  <span class="n">score</span><span class="p">,</span> <span class="n">cv</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MCC score:</span><span class="se">\t</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameters:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>

            <span class="c1"># Set the best parameters to the best estimator</span>
            <span class="n">best_classifier</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_estimator_</span>
            <span class="k">return</span> <span class="n">best_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;nn&#39;</span><span class="p">:</span>
            <span class="n">pipe_rf</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s1">&#39;scl&#39;</span><span class="p">,</span> <span class="n">scaler</span><span class="p">),</span>
                                <span class="p">(</span><span class="s1">&#39;clf&#39;</span><span class="p">,</span> <span class="n">MLPClassifier</span><span class="p">())])</span>

            <span class="k">if</span> <span class="n">param_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param_grid</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;clf__activation&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="s1">&#39;logistic&#39;</span><span class="p">,</span> <span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="s1">&#39;relu&#39;</span><span class="p">],</span>
                               <span class="c1">#&#39;clf__solver&#39;: [&#39;lbfgs&#39;, &#39;sgd&#39;, &#39;adam&#39;],</span>
                                <span class="c1">#&#39;clf__learning_rate&#39;: [ &#39;constant&#39;, &#39;invscaling&#39;, &#39;adaptive&#39;],</span>
                               <span class="s1">&#39;clf__batch_size&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">]}]</span>

            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">pipe_rf</span><span class="p">,</span>
                              <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span>
                              <span class="n">scoring</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                              <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
                              <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>

            <span class="n">gs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best score </span><span class="si">%s</span><span class="s2"> (scorer: </span><span class="si">%s</span><span class="s2">) and parameters from a </span><span class="si">%d</span><span class="s2">-fold cross validation:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                                                                                  <span class="n">score</span><span class="p">,</span> <span class="n">cv</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MCC score:</span><span class="se">\t</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameters:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>

            <span class="c1"># Set the best parameters to the best estimator</span>
            <span class="n">best_classifier</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_estimator_</span>
            <span class="n">best_classifier_fit</span><span class="o">=</span><span class="n">best_classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">best_classifier_fit</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model not supported, please choose between &#39;svm&#39;, &#39;knn&#39;, &#39;sgd&#39;, &#39;rf&#39;, &#39;gnb&#39;, &#39;nn&#39;, &#39;gboosting&#39; &quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MachineLearning.plot_validation_curve"><a class="viewcode-back" href="../../propythia.html#propythia.machine_learning.MachineLearning.plot_validation_curve">[docs]</a>    <span class="k">def</span> <span class="nf">plot_validation_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">classifier</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param_range</span><span class="p">,</span>
                              <span class="n">cv</span><span class="o">=</span><span class="n">ShuffleSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
                              <span class="n">score</span><span class="o">=</span><span class="n">make_scorer</span><span class="p">(</span><span class="n">matthews_corrcoef</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Validation Curve&quot;</span><span class="p">,</span>
                              <span class="n">xlab</span><span class="o">=</span><span class="s2">&quot;parameter range&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s2">&quot;MCC&quot;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This function plots a cross-validation curve for the specified classifier on all tested parameters given in</span>
<span class="sd">        the option &#39;param_range&#39;.</span>

<span class="sd">        :param classifier: {classifier instance} classifier or validation curve (e.g. sklearn.svm.SVC).</span>
<span class="sd">        :param x_train: {array} descriptor values for training data.</span>
<span class="sd">        :param y_train: {array} class values for training data.</span>
<span class="sd">        :param param_name:</span>
<span class="sd">                {string} parameter to assess in the validation curve plot. For example,</span>
<span class="sd">                \n For SVM, &quot;clf__C&quot; (C parameter), &quot;clf__gamma&quot; (gamma parameter).</span>
<span class="sd">                \n For Random Forest,</span>
<span class="sd">                    \n &quot;clf__n_estimators&quot; (number of trees),&quot;clf__max_depth&quot; (max num of branches per tree,</span>
<span class="sd">                    \n &quot;clf__min_samples_split&quot; (min number of samples required to split an internal tree node),</span>
<span class="sd">                    \n &quot;clf__min_samples_leaf&quot; (min number of samples in newly created leaf).</span>

<span class="sd">        :param param_range: {list} parameter range for the validation curve.</span>
<span class="sd">        :param cv: {int} number of folds for cross-validation.</span>
<span class="sd">        :param score: {metrics instance} scoring function built from make_scorer() or a predefined value in string form</span>
<span class="sd">            `sklearn.model_evaluation.scoring-parameter</span>
<span class="sd">            &lt;http://scikit-learn.org/stable/modules/model_evaluation.html#scoring-parameter&gt;`_.</span>
<span class="sd">        :param title: {str} graph title</span>
<span class="sd">        :param xlab: {str} x axis label.</span>
<span class="sd">        :param ylab: {str} y axis label.</span>
<span class="sd">        :param n_jobs: {int} number of parallel jobs to use for calculation. if ``-1``, all available cores are used.</span>
<span class="sd">        :param filename: {str} if filename given the figure is stored in the specified path.</span>
<span class="sd">        :return: plot of the validation curve.</span>

<span class="sd">        Based on a function from moodlamp</span>
<span class="sd">        Müller A. T. et al. (2017) modlAMP: Python for anitmicrobial peptides, Bioinformatics 33, (17), 2753-2755,</span>
<span class="sd">        DOI:10.1093/bioinformatics/btx285</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">train_scores</span><span class="p">,</span> <span class="n">test_scores</span> <span class="o">=</span> <span class="n">validation_curve</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param_range</span><span class="p">,</span>
                                                     <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="n">score</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
        <span class="n">train_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">train_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">train_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">test_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">test_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">test_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">test_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># plotting</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">param_range</span><span class="p">,</span> <span class="n">train_mean</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Training score&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">param_range</span><span class="p">,</span> <span class="n">train_mean</span> <span class="o">-</span> <span class="n">train_std</span><span class="p">,</span> <span class="n">train_mean</span> <span class="o">+</span> <span class="n">train_std</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">param_range</span><span class="p">,</span> <span class="n">test_mean</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cross-validation score&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">param_range</span><span class="p">,</span> <span class="n">test_mean</span> <span class="o">-</span> <span class="n">test_std</span><span class="p">,</span> <span class="n">test_mean</span> <span class="o">+</span> <span class="n">test_std</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="MachineLearning.score_testset"><a class="viewcode-back" href="../../propythia.html#propythia.machine_learning.MachineLearning.score_testset">[docs]</a>    <span class="k">def</span> <span class="nf">score_testset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">classifier</span><span class="p">,</span> <span class="n">sample_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the tests set scores for the specified scoring metrics in a ``pandas.DataFrame``.</span>
<span class="sd">        The calculated metrics are Matthews correlation coefficient, accuracy, precision, recall, f1 and area under</span>
<span class="sd">        the Receiver-Operator Curve (roc_auc). See `sklearn.metrics &lt;http://scikit-learn.org/stable/modules/classes.html#sklearn-metrics-metrics&gt;`_</span>
<span class="sd">        for more information.</span>

<span class="sd">        :param classifier: {classifier instance} pre-trained classifier used for predictions.</span>
<span class="sd">        :param x_test: {array} descriptor values of the tests data.</span>
<span class="sd">        :param y_test: {array} true class values of the tests data.</span>
<span class="sd">        :param sample_weights: {array} weights for the tests data.</span>
<span class="sd">        :return: ``pandas.DataFrame`` containing the cross validation scores for the specified metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MCC&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="s1">&#39;roc_auc&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;TN&#39;</span><span class="p">,</span> <span class="s1">&#39;FP&#39;</span><span class="p">,</span> <span class="s1">&#39;FN&#39;</span><span class="p">,</span> <span class="s1">&#39;TP&#39;</span><span class="p">,</span> <span class="s1">&#39;FDR&#39;</span><span class="p">,</span> <span class="s1">&#39;sensitivity&#39;</span><span class="p">,</span> <span class="s1">&#39;specificity&#39;</span><span class="p">]</span>
        <span class="n">funcs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;matthews_corrcoef&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy_score&#39;</span><span class="p">,</span> <span class="s1">&#39;precision_score&#39;</span><span class="p">,</span> <span class="s1">&#39;recall_score&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_score&#39;</span><span class="p">,</span> <span class="s1">&#39;roc_auc_score&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;confusion_matrix&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
            <span class="c1"># fore every metric, calculate the scores</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">mets</span><span class="p">,</span> <span class="n">f</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test</span><span class="p">),</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weights</span><span class="p">))</span>

        <span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">+</span> <span class="p">[</span><span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span><span class="p">]</span>
        <span class="n">fdr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fdr</span><span class="p">)</span>
        <span class="n">sn</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sn</span><span class="p">)</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tn</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
        <span class="n">df_scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Scores&#39;</span><span class="p">:</span> <span class="n">scores</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_scores</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="MachineLearning.plot_roc_curve"><a class="viewcode-back" href="../../propythia.html#propythia.machine_learning.MachineLearning.plot_roc_curve">[docs]</a>    <span class="k">def</span> <span class="nf">plot_roc_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">classifier</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">],</span> <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Receiver operating characteristic&#39;</span><span class="p">):</span> <span class="c1">#for binary class</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to plot a ROC curve</span>
<span class="sd">         On the y axis, true positive rate and false positive rate on the X axis.</span>
<span class="sd">         The top left corner of the plot is the &#39;ideal&#39; point - a false positive rate of zero, and a true positive rate of one,</span>
<span class="sd">         meaning a larger area under the curve (AUC) is usually better.</span>

<span class="sd">        :param classifier: {classifier instance} pre-trained classifier used for predictions.</span>
<span class="sd">        :param x_test: {array} descriptor values of the tests data.</span>
<span class="sd">        :param y_test:{array} true class values of the tests data.</span>
<span class="sd">        :param ylim: y-axis limits</span>
<span class="sd">        :param xlim: x- axis limits</span>
<span class="sd">        :param title: title of plot</span>
<span class="sd">        :return: plot ROC curve</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">y_score</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test</span><span class="p">)</span>
        <span class="c1"># y_score = classifier.predict_proba(X_test)[:,1]</span>
        <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_score</span><span class="p">)</span>
        <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">roc_auc</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span>
                 <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ROC curve (area = </span><span class="si">%0.2f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">roc_auc</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="MachineLearning.features_importances"><a class="viewcode-back" href="../../propythia.html#propythia.machine_learning.MachineLearning.features_importances">[docs]</a>    <span class="k">def</span> <span class="nf">features_importances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">classifier</span><span class="p">,</span><span class="n">model_name</span><span class="p">,</span><span class="n">top_features</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function that given a classifier retrieves the features importances as a dataset and represent as barplot.</span>

<span class="sd">        :param classifier: classifier</span>
<span class="sd">        :param model_name: model used in classifier. Choose between &#39;svm&#39;, &#39;sgd&#39;, &#39;lr&#39;, &#39;gboosting&#39; or &#39;rf&#39;</span>
<span class="sd">        :param x_train: descriptor values for training data.</span>
<span class="sd">        :param top_features: number of features to display on plot</span>
<span class="sd">        :param color: color of plot bard</span>
<span class="sd">        :return: bar plot of features and table with features names and importance for the model</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">feature_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span>

        <span class="k">if</span> <span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;rf&#39;</span><span class="p">,</span> <span class="s1">&#39;gboosting&#39;</span><span class="p">):</span>

            <span class="n">feature_importance</span><span class="o">=</span><span class="n">classifier</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;clf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>
            <span class="n">feat_table</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">feature_importance</span><span class="p">,</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1">#creating plot</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">feature_importance</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ind</span><span class="p">)[</span><span class="o">-</span><span class="n">top_features</span><span class="p">:]</span> <span class="c1">#top ranking features</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Feature Importances&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)),</span> <span class="n">ind</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)),</span> <span class="n">feature_names</span><span class="p">[</span><span class="n">indices</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Relative Importance&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">feat_table</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">feat_table</span>

        <span class="k">elif</span> <span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;svm&#39;</span><span class="p">,</span> <span class="s1">&#39;sgd&#39;</span><span class="p">,</span> <span class="s1">&#39;lr&#39;</span><span class="p">):</span>

            <span class="n">feature_importance</span><span class="o">=</span><span class="n">classifier</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;clf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="n">feature_importance</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">top_features</span><span class="o">=</span><span class="n">top_features</span><span class="o">//</span><span class="mi">2</span> <span class="c1"># to consider posiive and negative</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">))</span><span class="o">&lt;</span><span class="n">top_features</span><span class="p">:</span> <span class="n">top_features</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>

            <span class="n">top_positive_coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">coef</span><span class="p">)[</span><span class="o">-</span><span class="n">top_features</span><span class="p">:]</span>
            <span class="n">top_negative_coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">coef</span><span class="p">)[:</span><span class="n">top_features</span><span class="p">]</span>
            <span class="n">top_coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">top_negative_coefficients</span><span class="p">,</span> <span class="n">top_positive_coefficients</span><span class="p">])</span>
            <span class="n">unique</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="p">[</span><span class="n">unique</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">top_coefficients</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">]</span> <span class="c1"># remove duplicates</span>
            <span class="n">top_coefficients</span><span class="o">=</span><span class="n">unique</span>

            <span class="n">feat_table</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">feature_importance</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">feat_table</span><span class="p">)</span>

            <span class="c1"># create plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;blue&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coef</span><span class="p">[</span><span class="n">top_coefficients</span><span class="p">]]</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_coefficients</span><span class="p">)),</span> <span class="n">coef</span><span class="p">[</span><span class="n">top_coefficients</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
            <span class="n">feature_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">feature_names</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">top_coefficients</span><span class="p">)),</span> <span class="n">feature_names</span><span class="p">[</span><span class="n">top_coefficients</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">feat_table</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model not supported, please choose between &#39;svm&#39;, &#39;sgd&#39;, &#39;lr&#39;, &#39;rf&#39; or &#39;gnb&#39;&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MachineLearning.plot_learning_curve"><a class="viewcode-back" href="../../propythia.html#propythia.machine_learning.MachineLearning.plot_learning_curve">[docs]</a>    <span class="k">def</span> <span class="nf">plot_learning_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">estimator</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Learning curve </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">cv</span><span class="o">=</span><span class="n">ShuffleSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
                            <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">train_sizes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a learning curve to determine cross validated training and tests scores for different training set sizes</span>

<span class="sd">        :param estimator: classifier/ model to use</span>
<span class="sd">        :param title: title of the plot</span>
<span class="sd">        :param ylim:</span>
<span class="sd">        :param cv: cross validation to use</span>
<span class="sd">        :param n_jobs:  number of parallel jobs to use for calculation. if ``-1``, all available cores are used.</span>
<span class="sd">        :param train_sizes: train sizes to tests</span>
<span class="sd">        :return: graphic representing learning curves, nº of trainig examples, scores on training and on tests set</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">*</span><span class="n">ylim</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Training examples&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Score&quot;</span><span class="p">)</span>
        <span class="n">train_sizes</span><span class="p">,</span> <span class="n">train_scores</span><span class="p">,</span> <span class="n">test_scores</span> <span class="o">=</span> <span class="n">learning_curve</span><span class="p">(</span>
            <span class="n">estimator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_data</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">train_sizes</span><span class="o">=</span><span class="n">train_sizes</span><span class="p">)</span>

        <span class="n">train_scores_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">train_scores_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">train_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">test_scores_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">test_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">test_scores_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">test_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">,</span> <span class="n">train_scores_mean</span> <span class="o">-</span> <span class="n">train_scores_std</span><span class="p">,</span>
                         <span class="n">train_scores_mean</span> <span class="o">+</span> <span class="n">train_scores_std</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                         <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">,</span> <span class="n">test_scores_mean</span> <span class="o">-</span> <span class="n">test_scores_std</span><span class="p">,</span>
                         <span class="n">test_scores_mean</span> <span class="o">+</span> <span class="n">test_scores_std</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">,</span> <span class="n">train_scores_mean</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Training score&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">,</span> <span class="n">test_scores_mean</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cross-validation score&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">train_sizes</span><span class="p">,</span> <span class="n">train_scores</span><span class="p">,</span> <span class="n">test_scores</span><span class="p">,</span><span class="n">plt</span></div>

<div class="viewcode-block" id="MachineLearning.predict"><a class="viewcode-back" href="../../propythia.html#propythia.machine_learning.MachineLearning.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">classifier</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">seqs</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This function can be used to predict novel peptides with a trained classifier model. The function returns a</span>
<span class="sd">        &#39;pandas.DataFrame&#39; with predictions using the specified estimator and tests data. If true class is provided,</span>
<span class="sd">        it returns the scoring value for the tests data.</span>

<span class="sd">        :param classifier: {classifier instance} classifier used for predictions.</span>
<span class="sd">        :param x: {array} descriptor values of the peptides to be predicted.</span>
<span class="sd">        :param seqs: {list} sequences of the peptides in ``x``.</span>
<span class="sd">        :param names: {list} (optional) names of the peptides in ``x``.</span>
<span class="sd">        :param y: {array} (optional) true (known) classes of the peptides.</span>
<span class="sd">        :param filename: {string} (optional) output filename to store the predictions to (``.csv`` format); if ``None``:</span>
<span class="sd">            not saved.</span>
<span class="sd">        :return: ``pandas.DataFrame`` containing predictions for ``x``. ``P_class0`` and ``P_class1``</span>
<span class="sd">            are the predicted probability of the peptide belonging to class 0 and class 1, respectively.</span>

<span class="sd">        Based on a function from moodlamp</span>
<span class="sd">        Müller A. T. et al. (2017) modlAMP: Python for anitmicrobial peptides, Bioinformatics 33, (17), 2753-2755,</span>
<span class="sd">        DOI:10.1093/bioinformatics/btx285</span>
<span class="sd">       &quot;&quot;&quot;</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">predict</span><span class="o">=</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">y</span> <span class="ow">and</span> <span class="n">names</span><span class="p">):</span>
            <span class="n">d_pred</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;P_class0&#39;</span><span class="p">:</span> <span class="n">preds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;P_class1&#39;</span><span class="p">:</span> <span class="n">preds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]}</span>
            <span class="n">df_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">seqs</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">y</span><span class="p">:</span>
            <span class="n">d_pred</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="n">names</span><span class="p">,</span> <span class="s1">&#39;P_class0&#39;</span><span class="p">:</span> <span class="n">preds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;P_class1&#39;</span><span class="p">:</span> <span class="n">preds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]}</span>
            <span class="n">df_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">seqs</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">d_pred</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;P_class0&#39;</span><span class="p">:</span> <span class="n">preds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;P_class1&#39;</span><span class="p">:</span> <span class="n">preds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;True_class&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">}</span>
            <span class="n">df_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">seqs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">d_pred</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="n">names</span><span class="p">,</span> <span class="s1">&#39;P_class0&#39;</span><span class="p">:</span> <span class="n">preds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;P_class1&#39;</span><span class="p">:</span> <span class="n">preds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;True_class&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">}</span>
            <span class="n">df_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">seqs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">df_pred</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;-%Y%m</span><span class="si">%d</span><span class="s2">esc-%H%M%S.csv&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">df_pred</span></div>

    <span class="c1"># alternatively the user can use the function GetSubSeq(self,protein_sequence,ToAA=&#39;S&#39;,window=3)</span>
    <span class="c1"># from the readsequence module</span>
    <span class="c1"># that Get all 2*window+1 sub-sequences whose center is ToAA (a specific aminoacid) in a protein</span>
    <span class="c1"># giving a ToAA and a window</span>

<div class="viewcode-block" id="MachineLearning.add_features"><a class="viewcode-back" href="../../propythia.html#propythia.machine_learning.MachineLearning.add_features">[docs]</a>    <span class="k">def</span> <span class="nf">add_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">list_of_sequences</span><span class="p">,</span><span class="n">list_functions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate all features available in package or lis of descriptors given</span>

<span class="sd">        :param list_functions: list of features to be calculated with function adaptable from module Descriptors</span>
<span class="sd">        :param list_of_sequences: list of sequences to calculate features</span>
<span class="sd">        :return: dataframe with sequences and its features</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">features_list</span><span class="o">=</span><span class="p">[]</span> <span class="c1">#creating an empty list of dataset rows</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">list_of_sequences</span><span class="p">:</span>
            <span class="n">res</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span><span class="n">seq</span><span class="p">}</span>
            <span class="n">sequence</span><span class="o">=</span><span class="n">ReadSequence</span><span class="p">()</span> <span class="c1">#creating sequence object</span>
            <span class="n">ps</span><span class="o">=</span><span class="n">sequence</span><span class="o">.</span><span class="n">read_protein_sequence</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
            <span class="n">protein</span> <span class="o">=</span> <span class="n">Descriptor</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span> <span class="c1"># creating object to calculate descriptors)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_functions</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">feature</span><span class="o">=</span><span class="n">protein</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">tricomp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bin_aa</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bin_prop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">feature</span><span class="o">=</span><span class="n">protein</span><span class="o">.</span><span class="n">adaptable</span><span class="p">(</span><span class="n">list_functions</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
            <span class="n">features_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">features_list</span><span class="p">)</span>
        <span class="c1">#df.set_index([&#39;sequence&#39;],inplace=True)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="MachineLearning.predict_window"><a class="viewcode-back" href="../../propythia.html#propythia.machine_learning.MachineLearning.predict_window">[docs]</a>    <span class="k">def</span> <span class="nf">predict_window</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">classifier</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">features</span><span class="o">=</span><span class="p">[],</span> <span class="n">features_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">features_dataframe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scan a protein in a sliding window approach to predict novel peptides with a trained classifier model.</span>
<span class="sd">        The function returns a</span>
<span class="sd">        &#39;pandas.DataFrame&#39; with predictions using the specified estimator and tests data. If true class is provided,</span>
<span class="sd">        it returns the scoring value for the tests data.</span>
<span class="sd">        The user can provide a features_dataframe if does not want to use the descriptors supported. Otherwise, the user</span>
<span class="sd">        can also provide a list with the numbers of the descriptors that want to be calculated</span>
<span class="sd">        (descriptors module adaptable()).</span>
<span class="sd">        if none is provided, the function will calculate all the descriptors available.</span>

<span class="sd">        :param classifier: {classifier instance} classifier used for predictions.</span>
<span class="sd">        :param x: {array} descriptor values of the peptides to be predicted.</span>
<span class="sd">        :param seq:  sequence of the peptides in ``x``.</span>
<span class="sd">        :param window_size: number of aminoacids to considerer in each seq to check. for default 20</span>
<span class="sd">        :param gap: gap size of the search of windows in sequence. default 1</span>
<span class="sd">        :param features: list containing the list features to be calculated under de adaptable function.</span>
<span class="sd">                if list is empty will calculate all the descriptors available in the package</span>
<span class="sd">        :param features_dataframe: dataframe with sequences and its features</span>
<span class="sd">        :param features_names: names of features. If none will match the features with the ones with the model given</span>
<span class="sd">        :param names: {list} (optional) names of the peptides in ``x``.</span>
<span class="sd">        :param y: {array} (optional) true (known) classes of the peptides.</span>
<span class="sd">        :param filename:</span>
<span class="sd">            {string} (optional) output filename to store the predictions to (``.csv`` format); if ``None``: not saved.</span>
<span class="sd">        :return: ``pandas.DataFrame`` containing predictions for subsequences generated, ``P_class0`` and ``P_class1``</span>
<span class="sd">            are the predicted probability of the peptide belonging to class 0 and class 1, respectively. The previsions</span>
<span class="sd">            are divided in probability classes &lt;0.99, &gt;0.95, &gt;0.9, &lt;0.8, &gt;0.7, &gt;0.6 and 0</span>
<span class="sd">       &quot;&quot;&quot;</span>

        <span class="c1">#generate final list of sequences/split sequences</span>
        <span class="n">list_of_sequences</span><span class="p">,</span><span class="n">indices</span><span class="o">=</span><span class="n">sub_seq_sliding_window</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span><span class="n">window_size</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


        <span class="c1">#calculate features for sequences</span>

        <span class="c1">#if a dataframe with features calculated that will be considered</span>
        <span class="c1">#if not features will be calculated.</span>
            <span class="c1"># if features is none will calculate all the features according to the package and choose the features for the classifier</span>
            <span class="c1"># if features is list with numbers will call the adaptable function</span>

        <span class="k">if</span> <span class="n">features_dataframe</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span> <span class="n">featuresDF</span><span class="o">=</span><span class="n">features_dataframe</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">featuresDF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_features</span><span class="p">(</span><span class="n">list_of_sequences</span><span class="p">,</span><span class="n">features</span><span class="p">)</span>

        <span class="c1">#select the features used for the model construction</span>
        <span class="k">if</span> <span class="n">features_names</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">features_to_select</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X_data</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">features_to_select</span><span class="o">=</span> <span class="n">features_names</span>

        <span class="n">x_predict_data</span><span class="o">=</span><span class="n">featuresDF</span><span class="p">[</span><span class="n">features_to_select</span><span class="p">]</span>

        <span class="c1"># raw proability predictions of belonging or not</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x_predict_data</span><span class="p">)</span>
        <span class="c1"># 0 or 1 if belong or not</span>
        <span class="n">predict</span><span class="o">=</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_predict_data</span><span class="p">)</span>

        <span class="c1"># dataframe with probabilities</span>
        <span class="n">df_pred</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">x_predict_data</span><span class="p">,</span> <span class="n">list_of_sequences</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">df_pred</span><span class="p">[</span><span class="s1">&#39;prevision&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">predict</span>
        <span class="n">df_pred</span><span class="p">[</span><span class="s1">&#39;pos_0&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
        <span class="n">df_pred</span><span class="p">[</span><span class="s1">&#39;pos_-1&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

        <span class="c1"># create a dataframe specifying really the sequences, indices, 1 and 0 and probability</span>
        <span class="c1"># (can put scale &gt;0.99, 095, 0.90, 0.8, 0.7, &lt;0.7</span>
        <span class="n">column</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span> <span class="s1">&#39;prevision&#39;</span><span class="p">,</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;scale_probability&#39;</span><span class="p">,</span> <span class="s1">&#39;pos_0&#39;</span><span class="p">,</span> <span class="s1">&#39;pos_-1&#39;</span><span class="p">]</span>
        <span class="n">sequence</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="n">pos_0</span><span class="o">=</span><span class="nb">int</span>
        <span class="n">pos_1</span><span class="o">=</span><span class="nb">int</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_pred</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">value</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;P_class1&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">&gt;=</span><span class="mf">0.99</span><span class="p">:</span>
                <span class="n">pos_0</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pos_0&#39;</span><span class="p">]</span>
                <span class="n">pos_1</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pos_-1&#39;</span><span class="p">]</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span> <span class="s1">&#39;prevision&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;scale_probability&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span>
                             <span class="s1">&#39;pos_0&#39;</span><span class="p">:</span><span class="n">pos_0</span><span class="p">,</span> <span class="s1">&#39;pos_-1&#39;</span><span class="p">:</span><span class="n">pos_1</span> <span class="p">})</span>

            <span class="k">if</span> <span class="n">value</span><span class="o">&gt;=</span><span class="mf">0.95</span> <span class="ow">and</span> <span class="n">value</span><span class="o">&lt;</span><span class="mf">0.99</span><span class="p">:</span>
                <span class="n">pos_0</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pos_0&#39;</span><span class="p">]</span>
                <span class="n">pos_1</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pos_-1&#39;</span><span class="p">]</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span> <span class="s1">&#39;prevision&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;scale_probability&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                             <span class="s1">&#39;pos_0&#39;</span><span class="p">:</span><span class="n">pos_0</span><span class="p">,</span> <span class="s1">&#39;pos_-1&#39;</span><span class="p">:</span><span class="n">pos_1</span> <span class="p">})</span>

            <span class="k">if</span> <span class="n">value</span><span class="o">&gt;=</span><span class="mf">0.90</span> <span class="ow">and</span> <span class="n">value</span><span class="o">&lt;</span><span class="mf">0.95</span><span class="p">:</span>
                <span class="n">pos_0</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pos_0&#39;</span><span class="p">]</span>
                <span class="n">pos_1</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pos_-1&#39;</span><span class="p">]</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span> <span class="s1">&#39;prevision&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;scale_probability&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
                              <span class="s1">&#39;pos_0&#39;</span><span class="p">:</span><span class="n">pos_0</span><span class="p">,</span> <span class="s1">&#39;pos_-1&#39;</span><span class="p">:</span><span class="n">pos_1</span> <span class="p">})</span>

            <span class="k">if</span> <span class="n">value</span><span class="o">&gt;=</span><span class="mf">0.80</span> <span class="ow">and</span> <span class="n">value</span><span class="o">&lt;</span><span class="mf">0.90</span><span class="p">:</span>
                <span class="n">pos_0</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pos_0&#39;</span><span class="p">]</span>
                <span class="n">pos_1</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pos_-1&#39;</span><span class="p">]</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span> <span class="s1">&#39;prevision&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">:</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;scale_probability&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
                              <span class="s1">&#39;pos_0&#39;</span><span class="p">:</span><span class="n">pos_0</span><span class="p">,</span> <span class="s1">&#39;pos_-1&#39;</span><span class="p">:</span><span class="n">pos_1</span> <span class="p">})</span>

            <span class="k">if</span> <span class="n">value</span><span class="o">&gt;=</span><span class="mf">0.70</span> <span class="ow">and</span> <span class="n">value</span><span class="o">&lt;</span><span class="mf">0.80</span><span class="p">:</span>
                <span class="n">pos_0</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pos_0&#39;</span><span class="p">]</span>
                <span class="n">pos_1</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pos_-1&#39;</span><span class="p">]</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span> <span class="s1">&#39;prevision&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;scale_probability&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                              <span class="s1">&#39;pos_0&#39;</span><span class="p">:</span><span class="n">pos_0</span><span class="p">,</span> <span class="s1">&#39;pos_-1&#39;</span><span class="p">:</span><span class="n">pos_1</span> <span class="p">})</span>

            <span class="k">if</span> <span class="n">value</span><span class="o">&gt;=</span><span class="mf">0.60</span> <span class="ow">and</span> <span class="n">value</span><span class="o">&lt;</span><span class="mf">0.70</span><span class="p">:</span>
                <span class="n">pos_0</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pos_0&#39;</span><span class="p">]</span>
                <span class="n">pos_1</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pos_-1&#39;</span><span class="p">]</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span> <span class="s1">&#39;prevision&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;scale_probability&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                             <span class="s1">&#39;pos_0&#39;</span><span class="p">:</span><span class="n">pos_0</span><span class="p">,</span> <span class="s1">&#39;pos_-1&#39;</span><span class="p">:</span><span class="n">pos_1</span> <span class="p">})</span>

            <span class="k">if</span> <span class="n">value</span><span class="o">&lt;</span><span class="mf">0.6</span><span class="p">:</span>
                <span class="n">pos_0</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pos_0&#39;</span><span class="p">]</span>
                <span class="n">pos_1</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pos_-1&#39;</span><span class="p">]</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span> <span class="s1">&#39;prevision&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;scale_probability&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                             <span class="s1">&#39;pos_0&#39;</span><span class="p">:</span><span class="n">pos_0</span><span class="p">,</span> <span class="s1">&#39;pos_-1&#39;</span><span class="p">:</span><span class="n">pos_1</span> <span class="p">})</span>

        <span class="c1"># create a new dataframe where consecutive rows in the same probability scale are joined and positions updated</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="c1"># dataframe with scale probabilities</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;scale_probability&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;scale_probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="c1"># add a sentinel column that tracks which group of consecutive data each row applies to</span>

        <span class="n">df_new</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span> <span class="s1">&#39;prevision&#39;</span><span class="p">])</span>
        <span class="n">x</span><span class="o">=</span><span class="n">df_new</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="c1">#not in pandas dataframe</span>
        <span class="n">remove_list</span><span class="o">=</span><span class="p">[]</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">pos_fin</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">pos_ini</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">prob</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">scale_prob</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">key</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]:</span>
                <span class="n">remove_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#select rows to delete</span>

        <span class="c1"># update the positions. is not made in the same loop because in more than two consecutive rows it will</span>
        <span class="c1"># update a row that will be deleted</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">remove_list</span><span class="p">):</span>
            <span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">remove_list</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="c1"># remove rows that were joined</span>
            <span class="k">del</span> <span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># add sequence</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
            <span class="n">seqs</span><span class="o">=</span><span class="n">seq</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="mi">2</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="mi">3</span><span class="p">])]</span>
            <span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seqs</span><span class="p">)</span>

        <span class="n">final_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;scale_probability&#39;</span><span class="p">,</span><span class="s1">&#39;pos_0&#39;</span><span class="p">,</span><span class="s1">&#39;pos_-1&#39;</span><span class="p">,</span><span class="s1">&#39;key&#39;</span><span class="p">,</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>
        <span class="n">final_df</span><span class="o">=</span><span class="n">final_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[[</span><span class="s1">&#39;pos_0&#39;</span><span class="p">,</span><span class="s1">&#39;pos_-1&#39;</span><span class="p">,</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;scale_probability&#39;</span><span class="p">,</span><span class="s1">&#39;sequence&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">final_df</span></div></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Ana Marta Sequeira

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>